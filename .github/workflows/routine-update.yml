name: Routine Customer IP Update

on:
  schedule:
    # Run Monday, Wednesday, Friday at 2am UTC
    - cron: '0 2 * * 1,3,5'
  workflow_dispatch:
    inputs:
      rotation_override:
        description: 'Force a specific rotation (0-3). Leave empty for auto.'
        required: false
        type: string

concurrency:
  group: routine-update
  cancel-in-progress: false

jobs:
  cleanup-old-demo-prs:
    name: Cleanup Stale Demo PRs
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Close stale demo PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Looking for demo PRs older than 7 days..."

          # Get all open PRs with demo/ prefix older than 7 days
          STALE_PRS=$(gh pr list \
            --state open \
            --json number,createdAt,headRefName \
            --jq '.[] | select(.headRefName | startswith("demo/")) | select((now - (.createdAt | fromdateiso8601)) > 604800) | .number')

          if [ -z "$STALE_PRS" ]; then
            echo "No stale demo PRs found."
          else
            echo "$STALE_PRS" | while read pr_num; do
              if [ -n "$pr_num" ]; then
                echo "Closing stale demo PR #${pr_num}"
                gh pr close "${pr_num}" \
                  --delete-branch \
                  --comment "ğŸ§¹ Closing stale demo PR (older than 7 days). Create a fresh one using the 'Create Demo PR' workflow."
              fi
            done
          fi

  routine-update:
    name: Apply Routine Customer Update
    needs: cleanup-old-demo-prs
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: modules/signals-demo
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.TERRAFORM_DEPLOY_ROLE }}
          aws-region: us-east-1

      - name: Calculate rotation
        id: rotation
        run: |
          if [ -n "${{ inputs.rotation_override }}" ]; then
            ROTATION="${{ inputs.rotation_override }}"
          else
            DAY_OF_YEAR=$(date +%j)
            ROTATION=$((DAY_OF_YEAR % 4))
          fi
          echo "rotation=${ROTATION}" >> $GITHUB_OUTPUT
          echo "Using rotation: ${ROTATION}"

      - name: Generate customer configuration
        run: |
          ROTATION=${{ steps.rotation.outputs.rotation }}

          case $ROTATION in
            0)
              echo "Rotation 0: Adding test customer A"
              cat > terraform.tfvars <<'EOF'
          customer_cidrs = {
            acme_corp   = { cidr = "203.0.113.10/32", name = "Acme Corp" }
            globex      = { cidr = "198.51.100.0/29", name = "Globex Industries" }
            initech     = { cidr = "192.0.2.50/32", name = "Initech" }
            umbrella    = { cidr = "198.18.100.0/24", name = "Umbrella Corp" }
            cyberdyne   = { cidr = "100.64.0.0/29", name = "Cyberdyne Systems" }
            rotation_a  = { cidr = "192.0.2.100/32", name = "Rotation Test A" }
          }

          internal_cidr = "10.0.0.0/8"
          demo_domain   = "signals-demo.overmind.tech"
          alert_email   = "demo-alerts@overmind.tech"
          EOF
              ;;

            1)
              echo "Rotation 1: Expanding Globex CIDR"
              cat > terraform.tfvars <<'EOF'
          customer_cidrs = {
            acme_corp   = { cidr = "203.0.113.10/32", name = "Acme Corp" }
            globex      = { cidr = "198.51.100.0/28", name = "Globex Industries" }
            initech     = { cidr = "192.0.2.50/32", name = "Initech" }
            umbrella    = { cidr = "198.18.100.0/24", name = "Umbrella Corp" }
            cyberdyne   = { cidr = "100.64.0.0/29", name = "Cyberdyne Systems" }
          }

          internal_cidr = "10.0.0.0/8"
          demo_domain   = "signals-demo.overmind.tech"
          alert_email   = "demo-alerts@overmind.tech"
          EOF
              ;;

            2)
              echo "Rotation 2: Adding test customers B and C"
              cat > terraform.tfvars <<'EOF'
          customer_cidrs = {
            acme_corp   = { cidr = "203.0.113.10/32", name = "Acme Corp" }
            globex      = { cidr = "198.51.100.0/29", name = "Globex Industries" }
            initech     = { cidr = "192.0.2.50/32", name = "Initech" }
            umbrella    = { cidr = "198.18.100.0/24", name = "Umbrella Corp" }
            cyberdyne   = { cidr = "100.64.0.0/29", name = "Cyberdyne Systems" }
            rotation_b  = { cidr = "172.16.50.0/28", name = "Rotation Test B" }
            rotation_c  = { cidr = "10.200.0.0/24", name = "Rotation Test C" }
          }

          internal_cidr = "10.0.0.0/8"
          demo_domain   = "signals-demo.overmind.tech"
          alert_email   = "demo-alerts@overmind.tech"
          EOF
              ;;

            3)
              echo "Rotation 3: Back to baseline"
              cat > terraform.tfvars <<'EOF'
          customer_cidrs = {
            acme_corp   = { cidr = "203.0.113.10/32", name = "Acme Corp" }
            globex      = { cidr = "198.51.100.0/29", name = "Globex Industries" }
            initech     = { cidr = "192.0.2.50/32", name = "Initech" }
            umbrella    = { cidr = "198.18.100.0/24", name = "Umbrella Corp" }
            cyberdyne   = { cidr = "100.64.0.0/29", name = "Cyberdyne Systems" }
          }

          internal_cidr = "10.0.0.0/8"
          demo_domain   = "signals-demo.overmind.tech"
          alert_email   = "demo-alerts@overmind.tech"
          EOF
              ;;

          esac

          echo "Generated terraform.tfvars:"
          cat terraform.tfvars

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

      - name: Commit updated tfvars
        run: |
          cd ../..
          git config user.name "Signals Demo Bot"
          git config user.email "demo-bot@overmind.tech"

          git add modules/signals-demo/terraform.tfvars

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: routine customer IP rotation (rotation ${{ steps.rotation.outputs.rotation }})"
            git push
          fi
