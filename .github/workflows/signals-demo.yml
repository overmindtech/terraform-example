name: Update Customer IP Ranges

on:
  schedule:
    # Run every day at 2am UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      include_needle:
        description: Include needle scenario (tighten internal CIDR + open PR)
        type: boolean
        required: false
        default: false

concurrency:
  group: signals-demo
  cancel-in-progress: false

jobs:
  modify:
    name: Modify main.tf (routine or needle)
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          ref: main

      - name: Configure Git
        run: |
          # Use a neutral automation identity that matches what you'd typically see in real repos.
          git config user.name "Platform Automation"
          git config user.email "platform-automation@company.com"

      - name: Modify customer IP ranges
        run: |
          # Rotate customer IP ranges while maintaining valid CIDR blocks.
          #
          # Important: keep changes small and plausible (toggle between two nearby values),
          # so the routine job looks like a normal update and doesn't appear as a broad,
          # unrelated replacement of customer ranges. It does not need to be unique each run.
          python3 - <<'PY'
          import sys
          from typing import Tuple, List

          path = "main.tf"
          content = open(path, "r").read()

          pairs: List[Tuple[str, str]] = [
              # /32 single IPs: toggle last octet by +1
              ("203.0.113.15/32", "203.0.113.16/32"),
              ("192.0.2.55/32", "192.0.2.56/32"),
              # Network CIDRs: keep routine changes *overlapping* and small.
              #
              # We avoid swapping to a totally different, non-overlapping CIDR (even if "nearby"),
              # because that doesn't resemble an innocuous allowlist maintenance update.
              #
              # /29 <-> /28: slight broadening/tightening within the same /24 (overlapping).
              ("198.51.105.8/29", "198.51.105.0/28"),
              ("198.51.105.0/29", "198.51.105.0/28"),
              ("100.64.5.8/29", "100.64.5.0/28"),
              ("100.64.5.0/29", "100.64.5.0/28"),
              # /24 <-> /25: small tightening/loosening that remains within the same /24 (overlapping).
              ("198.18.106.0/24", "198.18.106.0/25"),
              ("198.18.105.0/24", "198.18.105.0/25"),
          ]

          updated = content
          changes = 0
          for a, b in pairs:
              if a in updated:
                  updated = updated.replace(a, b)
                  changes += 1
              elif b in updated:
                  updated = updated.replace(b, a)
                  changes += 1

          if updated == content:
              print("Error: no customer CIDRs updated (patterns not found).", file=sys.stderr)
              sys.exit(1)

          open(path, "w").write(updated)
          print(f"Toggled {changes} customer CIDR(s) (small change).")
          PY

      - name: Needle scenario - tighten internal CIDR
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.include_needle == 'true' }}
        run: |
          python3 .github/scripts/update-internal-cidr.py main.tf "10.0.0.0/16" "SECURITY HARDENING: Narrowed to VPC CIDR per audit findings"

      - name: Show changes
        run: |
          echo "## Changes to main.tf" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```diff' >> $GITHUB_STEP_SUMMARY
          git diff main.tf >> $GITHUB_STEP_SUMMARY || echo "No changes detected"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          # Also print to console
          echo "=== Git diff ==="
          git diff main.tf || echo "No changes detected"

      - name: Upload artifact (modified main.tf)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signals-demo-main-tf
          if-no-files-found: error
          path: |
            main.tf

  plan-and-apply:
    name: Terraform plan/apply (routine only)
    runs-on: ubuntu-latest
    needs: modify
    if: >-
      ${{
        needs.modify.result == 'success' &&
        (
          github.event_name == 'schedule' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.include_needle != 'true')
        )
      }}
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          ref: main

      - name: Download modified main.tf
        uses: actions/download-artifact@v4
        with:
          name: signals-demo-main-tf
          path: ./artifacts

      - name: Restore modified main.tf
        run: |
          cp ./artifacts/main.tf ./main.tf

      - name: Terraform Init
        uses: ./.github/actions/terraform_init/
        with:
          terraform_deploy_role: ${{ vars.TERRAFORM_DEPLOY_ROLE }}
          terraform_workspace: terraform-example

      - name: Terraform Plan
        run: terraform plan -out=tfplan

      - name: Convert plan to JSON
        run: terraform show -json tfplan > tfplan.json

      - uses: overmindtech/actions/install-cli@main
        with:
          version: latest
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - uses: overmindtech/actions/submit-plan@main
        id: submit-plan
        with:
          ovm-api-key: ${{ secrets.OVM_API_KEY }}
          plan-json: tfplan.json
          tags: 'model=risks_v6'

      - uses: overmindtech/actions/start-change@main
        with:
          ovm-api-key: ${{ secrets.OVM_API_KEY }}

      - name: Terraform Apply
        id: terraform-apply
        run: terraform apply -auto-approve tfplan

      - uses: overmindtech/actions/end-change@main
        if: steps.terraform-apply.outcome == 'success'
        with:
          ovm-api-key: ${{ secrets.OVM_API_KEY }}

      - name: Upload plan artifacts (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signals-demo-tfplan
          if-no-files-found: ignore
          path: |
            tfplan
            tfplan.json

  commit-routine:
    name: Commit routine changes directly to main
    runs-on: ubuntu-latest
    needs: plan-and-apply
    if: >-
      ${{
        needs.plan-and-apply.result == 'success' &&
        (
          github.event_name == 'schedule' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.include_needle != 'true')
        )
      }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          ref: main

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure Git
        run: |
          git config user.name "Platform Automation"
          git config user.email "platform-automation@company.com"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: signals-demo-main-tf
          path: ./artifacts

      - name: Restore modified main.tf
        run: |
          cp ./artifacts/main.tf ./main.tf

      - name: Terraform fmt
        run: terraform fmt -no-color main.tf

      - name: Commit and push
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git add main.tf
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update customer IP ranges"
            git push origin main
          fi

  create-pr:
    name: Create PR for security hardening change
    runs-on: ubuntu-latest
    needs: modify
    if: >-
      ${{
        needs.modify.result == 'success' &&
        github.event_name == 'workflow_dispatch' &&
        github.event.inputs.include_needle == 'true'
      }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          ref: main

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure Git
        run: |
          git config user.name "Platform Automation"
          git config user.email "platform-automation@company.com"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: signals-demo-main-tf
          path: ./artifacts

      - name: Restore modified main.tf
        run: |
          cp ./artifacts/main.tf ./main.tf

      - name: Terraform fmt
        run: terraform fmt -no-color main.tf

      - name: Create branch, commit, and push
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Use a realistic branch naming convention (team/topic + ticket).
          BRANCH="security/jira-4521-narrow-internal-cidr-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

          git checkout -b "$BRANCH"
          git add main.tf

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "security: narrow internal ingress CIDR (JIRA-4521)"
          git push -u origin "$BRANCH"

      - name: Open pull request
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          BODY="$(printf '%s\n' \
            '## Summary' \
            '- Narrow internal ingress CIDR used for service/monitoring access.' \
            '' \
            '## Context' \
            '- JIRA-4521: Reduce internal exposure based on audit feedback.' \
            '' \
            '## Testing' \
            '- Terraform plan reviewed in CI.' \
            '' \
            '## Rollout / Risk' \
            '- If any internal tooling relies on the broader range, it may lose access; monitor health checks and alarms after merge.' \
          )"

          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "security: narrow internal ingress CIDR (JIRA-4521)" \
            --body "$BODY"
