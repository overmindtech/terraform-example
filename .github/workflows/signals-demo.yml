name: Update Customer IP Ranges

on:
  schedule:
    # Run every day at 2am UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      include_needle:
        description: Include needle scenario (tighten internal CIDR + open PR)
        type: boolean
        required: false
        default: false

concurrency:
  group: signals-demo
  cancel-in-progress: false

jobs:
  modify-and-apply:
    name: Modify config + terraform plan/apply
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          ref: main

      - name: Configure Git
        run: |
          git config user.name "Signals Demo Bot"
          git config user.email "demo-bot@overmind.tech"

      - name: Modify customer IP ranges
        run: |
          # Rotate customer IP ranges while maintaining valid CIDR blocks
          # CIDR blocks must use network addresses (last octet = 0 for /24, /29, etc.)
          # Use seconds since epoch to ensure each run produces different values
          SECONDS_SINCE_EPOCH=$(date +%s)
          OFFSET=$((SECONDS_SINCE_EPOCH % 10))
          
          # For /32 blocks (single IPs), modify the last octet
          sed -i "s|\(203\.0\.113\.\)[0-9]\+\(/32\)|\1$((10 + OFFSET))\2|g" main.tf
          sed -i "s|\(192\.0\.2\.\)[0-9]\+\(/32\)|\1$((50 + OFFSET))\2|g" main.tf
          
          # For /29 blocks: normalize to .0 first, then modify third octet
          sed -i "s|198\.51\.[0-9]\+\.\([0-9]\+\)/29|198.51.$((100 + OFFSET)).0/29|g" main.tf
          
          # For /24 blocks: normalize to .0 first, then modify third octet
          sed -i "s|198\.18\.[0-9]\+\.\([0-9]\+\)/24|198.18.$((100 + OFFSET)).0/24|g" main.tf
          
          # For 100.64.x.x/29 blocks: normalize to .0 first, then modify third octet
          sed -i "s|100\.64\.[0-9]\+\.\([0-9]\+\)/29|100.64.$((OFFSET)).0/29|g" main.tf
          
          echo "Modified customer IP ranges with offset: ${OFFSET} (based on seconds since epoch: ${SECONDS_SINCE_EPOCH})"

      - name: Needle scenario - tighten internal CIDR
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.include_needle == 'true' }}
        run: |
          python3 .github/scripts/update-internal-cidr.py main.tf "10.50.0.0/16" "SECURITY HARDENING: Narrowed per audit findings"

      - name: Show changes
        run: |
          echo "## Changes to main.tf" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```diff' >> $GITHUB_STEP_SUMMARY
          git diff main.tf >> $GITHUB_STEP_SUMMARY || echo "No changes detected"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          # Also print to console
          echo "=== Git diff ==="
          git diff main.tf || echo "No changes detected"

      - name: Terraform Init
        uses: ./.github/actions/terraform_init/
        with:
          terraform_deploy_role: ${{ vars.TERRAFORM_DEPLOY_ROLE }}
          terraform_workspace: terraform-example

      - name: Terraform Plan
        run: terraform plan -out=tfplan

      - name: Convert plan to JSON
        run: terraform show -json tfplan > tfplan.json

      - uses: overmindtech/actions/install-cli@main
        with:
          version: latest
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - uses: overmindtech/actions/submit-plan@main
        id: submit-plan
        with:
          ovm-api-key: ${{ secrets.OVM_API_KEY }}
          plan-json: tfplan.json
          tags: 'model=risks_v6'

      - uses: overmindtech/actions/start-change@main
        with:
          ovm-api-key: ${{ secrets.OVM_API_KEY }}

      - name: Terraform Apply
        id: terraform-apply
        run: terraform apply -auto-approve tfplan

      - uses: overmindtech/actions/end-change@main
        if: steps.terraform-apply.outcome == 'success'
        with:
          ovm-api-key: ${{ secrets.OVM_API_KEY }}

      - name: Upload artifacts (main.tf + terraform plan)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signals-demo-artifacts
          if-no-files-found: error
          path: |
            main.tf
            tfplan
            tfplan.json

  commit-routine:
    name: Commit routine changes directly to main
    runs-on: ubuntu-latest
    needs: modify-and-apply
    if: >-
      ${{
        needs.modify-and-apply.result == 'success' &&
        (
          github.event_name == 'schedule' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.include_needle != 'true')
        )
      }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          ref: main

      - name: Configure Git
        run: |
          git config user.name "Signals Demo Bot"
          git config user.email "demo-bot@overmind.tech"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: signals-demo-artifacts
          path: ./artifacts

      - name: Restore modified main.tf
        run: |
          cp ./artifacts/main.tf ./main.tf

      - name: Commit and push
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git add main.tf
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update customer IP ranges"
            git push origin main
          fi

  create-pr:
    name: Create PR for needle scenario
    runs-on: ubuntu-latest
    needs: modify-and-apply
    if: >-
      ${{
        needs.modify-and-apply.result == 'success' &&
        github.event_name == 'workflow_dispatch' &&
        github.event.inputs.include_needle == 'true'
      }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          ref: main

      - name: Configure Git
        run: |
          git config user.name "Signals Demo Bot"
          git config user.email "demo-bot@overmind.tech"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: signals-demo-artifacts
          path: ./artifacts

      - name: Restore modified main.tf
        run: |
          cp ./artifacts/main.tf ./main.tf

      - name: Create branch, commit, and push
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          BRANCH="signals-demo/needle-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

          git checkout -b "$BRANCH"
          git add main.tf

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "feat: add new customers and tighten internal CIDR"
          git push -u origin "$BRANCH"

      - name: Open pull request
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          BODY="$(printf '%s\n' \
            '## Summary' \
            '- Add new customers and rotate customer IP allowlist ranges (routine change).' \
            '- SECURITY HARDENING (JIRA-4521): Narrow internal CIDR from `10.0.0.0/8` to `10.50.0.0/16` per audit findings.' \
            '' \
            '## Notes' \
            'This change looks safer (more restrictive) and passes typical policy checks, but can break monitoring/health checks and other internal tooling that is not within the VPC CIDR.' \
          )"

          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "feat: Add new customers + tighten internal SG per security audit" \
            --body "$BODY"
