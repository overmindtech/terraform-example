version: 2

deploy:
  steps:
    # COMMENTED OUT: Overmind integration steps
    terraformPlan:
      after:
        - name: Install Overmind CLI
          run: |
            #!/bin/sh
            set -e

            REPO="overmindtech/cli"

            # Preferred installation directories (in order of preference)
            PREFERRED_DIRS="/home/node/.local/bin:${HOME}/.local/bin:/opt/packages/bin:/usr/local/bin"

            OS=$(uname -s)
            ARCH=$(uname -m)

            case "${ARCH}" in
                x86_64) ARCH="x86_64" ;;
                aarch64|arm64) ARCH="arm64" ;;
                i386|i686) ARCH="i386" ;;
                *) echo "Unsupported architecture: ${ARCH}"; exit 1 ;;
            esac

            case "${OS}" in
                Linux|Darwin) ARCHIVE_EXT="tar.gz" ;;
                MINGW*|MSYS*|CYGWIN*) OS="Windows"; ARCHIVE_EXT="zip" ;;
                *) echo "Unsupported OS: ${OS}"; exit 1 ;;
            esac

            # Function to check if directory is writable and in PATH
            find_install_dir() {
                # First try preferred directories
                IFS=':'
                for dir in $PREFERRED_DIRS; do
                    [ -z "$dir" ] && continue
                    
                    # Create if parent is writable
                    if [ ! -d "$dir" ]; then
                        mkdir -p "$dir" 2>/dev/null || continue
                    fi
                    
                    # Check if writable and in PATH
                    if [ -w "$dir" ] && echo ":${PATH}:" | grep -q ":${dir}:"; then
                        echo "$dir"
                        return 0
                    fi
                done
                
                # Fall back to any writable directory in PATH
                for dir in $PATH; do
                    [ -z "$dir" ] && continue
                    [ -d "$dir" ] && [ -w "$dir" ] && echo "$dir" && return 0
                done
                unset IFS
                
                return 1
            }

            INSTALL_DIR=$(find_install_dir)

            if [ -z "${INSTALL_DIR}" ]; then
                echo "Error: No writable directory found in PATH"
                echo "Tried: ${PREFERRED_DIRS}"
                echo "Current PATH: ${PATH}"
                exit 1
            fi

            echo "Installing to: ${INSTALL_DIR}"

            echo "Detecting latest release..."
            LATEST_VERSION=$(curl -fsSL "https://api.github.com/repos/${REPO}/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')

            if [ -z "${LATEST_VERSION}" ]; then
                echo "Failed to fetch latest version"
                exit 1
            fi

            echo "Latest version: ${LATEST_VERSION}"
            VERSION_NUMBER=$(echo "${LATEST_VERSION}" | sed 's/^v//')

            FILENAME="overmind_cli_${VERSION_NUMBER}_${OS}_${ARCH}.${ARCHIVE_EXT}"
            DOWNLOAD_URL="https://github.com/${REPO}/releases/download/${LATEST_VERSION}/${FILENAME}"

            echo "Downloading ${FILENAME}..."

            TMP_DIR=$(mktemp -d)
            trap "rm -rf ${TMP_DIR}" EXIT
            cd "${TMP_DIR}"

            curl -fsSL "${DOWNLOAD_URL}" -o archive

            if [ "${ARCHIVE_EXT}" = "tar.gz" ]; then
                tar -xzf archive
            else
                unzip -q archive
            fi

            # Look for the binary - it's called 'overmind'
            BINARY=$(find . -maxdepth 1 -type f -executable -name "overmind*" ! -name "*.txt" ! -name "*.md" ! -name "LICENSE" | head -n 1)

            if [ -z "${BINARY}" ]; then
                echo "Error: Could not find binary in archive"
                ls -la
                exit 1
            fi

            cp "${BINARY}" "${INSTALL_DIR}/overmind"
            chmod +x "${INSTALL_DIR}/overmind"

            echo "✓ Overmind CLI ${LATEST_VERSION} installed to ${INSTALL_DIR}/overmind"
            echo "✓ Directory is already in PATH"

            "${INSTALL_DIR}/overmind" version 2>/dev/null || echo "Installation complete"
     
        - name: Display ENV0 Environment Variables
          run: |
            echo "=========================================="
            echo "ENV0 ENVIRONMENT VARIABLES"
            echo "=========================================="
            echo ""
            echo "ENV0_ENVIRONMENT_ID=${ENV0_ENVIRONMENT_ID:-not set}"
            echo "ENV0_PROJECT_ID=${ENV0_PROJECT_ID:-not set}"
            echo "ENV0_PROJECT_NAME=${ENV0_PROJECT_NAME:-not set}"
            echo "ENV0_DEPLOYMENT_LOG_ID=${ENV0_DEPLOYMENT_LOG_ID:-not set}"
            echo "ENV0_DEPLOYMENT_TYPE=${ENV0_DEPLOYMENT_TYPE:-not set}"
            echo "ENV0_DEPLOYMENT_REVISION=${ENV0_DEPLOYMENT_REVISION:-not set}"
            echo "ENV0_WORKSPACE_NAME=${ENV0_WORKSPACE_NAME:-not set}"
            echo "ENV0_ROOT_DIR=${ENV0_ROOT_DIR:-not set}"
            echo "ENV0_ORGANIZATION_ID=${ENV0_ORGANIZATION_ID:-not set}"
            echo "ENV0_TEMPLATE_ID=${ENV0_TEMPLATE_ID:-not set}"
            echo ""
            echo "=========================================="


        - name: Find plan file
          run: |
            #!/bin/sh
            set -e

            echo "=== Terraform Plan File Search ==="
            echo "Environment: ${ENV0_WORKSPACE_NAME:-unknown}"
            echo "Root Directory: ${ENV0_ROOT_DIR:-/tmp}"
            echo ""

            # Define search root (default to ENV0_ROOT_DIR or current directory)
            SEARCH_ROOT="${ENV0_ROOT_DIR:-.}"

            echo "Searching from: ${SEARCH_ROOT}"
            echo ""

            # Function to check if file is JSON
            is_json() {
                if command -v jq >/dev/null 2>&1; then
                    jq empty "$1" >/dev/null 2>&1
                else
                    grep -q "^\s*{" "$1" 2>/dev/null || grep -q "^\s*\[" "$1" 2>/dev/null
                fi
            }

            # Function to check if file looks like terraform plan JSON
            is_terraform_plan_json() {
                if command -v jq >/dev/null 2>&1; then
                    jq -e '.format_version // .terraform_version // .planned_values // .resource_changes' "$1" >/dev/null 2>&1
                else
                    grep -q "terraform_version\|planned_values\|resource_changes\|format_version" "$1" 2>/dev/null
                fi
            }

            echo "--- Searching for common plan file names ---"
            FOUND_FILES=""

            # Search for common binary plan file names
            for pattern in "tfplan" "terraform.tfplan" "plan.out" "*.tfplan" "*.plan"; do
                echo "Looking for: $pattern"
                find "$SEARCH_ROOT" -type f -name "$pattern" 2>/dev/null | while read -r file; do
                    echo "  ✓ Found: $file"
                    
                    # Get file info
                    size=$(du -h "$file" | cut -f1)
                    modified=$(ls -lh "$file" | awk '{print $6, $7, $8}')
                    
                    echo "    Size: $size"
                    echo "    Modified: $modified"
                    
                    # Check file type
                    if command -v file >/dev/null 2>&1; then
                        filetype=$(file -b "$file")
                        echo "    Type: $filetype"
                    fi
                    
                    # Check if it's binary or text
                    if file "$file" 2>/dev/null | grep -q "text"; then
                        echo "    Format: Text/JSON"
                        if is_terraform_plan_json "$file"; then
                            echo "    ✓ Appears to be Terraform plan JSON"
                        fi
                    else
                        echo "    Format: Binary"
                    fi
                    
                    echo ""
                    FOUND_FILES="${FOUND_FILES}${file}\n"
                done
            done

            echo "--- Searching for JSON files that might be plans ---"
            find "$SEARCH_ROOT" -type f -name "*.json" 2>/dev/null | while read -r file; do
                # Skip files that are too large (>50MB)
                size_bytes=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "0")
                if [ "$size_bytes" -gt 52428800 ]; then
                    continue
                fi
                
                if is_terraform_plan_json "$file"; then
                    echo "  ✓ Found Terraform plan JSON: $file"
                    size=$(du -h "$file" | cut -f1)
                    echo "    Size: $size"
                    
                    # Try to get some plan details
                    if command -v jq >/dev/null 2>&1; then
                        resource_changes=$(jq -r '.resource_changes | length' "$file" 2>/dev/null || echo "unknown")
                        echo "    Resource changes: $resource_changes"
                    fi
                    echo ""
                    FOUND_FILES="${FOUND_FILES}${file}\n"
                fi
            done

            echo "--- Searching in common Terraform directories ---"
            for dir in ".terraform" "terraform.tfstate.d" ".env0"; do
                if [ -d "$SEARCH_ROOT/$dir" ]; then
                    echo "Searching in: $SEARCH_ROOT/$dir"
                    find "$SEARCH_ROOT/$dir" -type f \( -name "*plan*" -o -name "*.tfplan" \) 2>/dev/null | while read -r file; do
                        echo "  ✓ Found: $file"
                        FOUND_FILES="${FOUND_FILES}${file}\n"
                    done
                fi
            done

            echo "--- Checking Terraform workspace ---"
            if [ -f "$SEARCH_ROOT/.terraform/environment" ]; then
                workspace=$(cat "$SEARCH_ROOT/.terraform/environment")
                echo "Current workspace: $workspace"
                
                # Check for workspace-specific files
                if [ -d "$SEARCH_ROOT/terraform.tfstate.d/$workspace" ]; then
                    echo "Searching workspace directory: terraform.tfstate.d/$workspace"
                    find "$SEARCH_ROOT/terraform.tfstate.d/$workspace" -type f 2>/dev/null | while read -r file; do
                        echo "  Found: $file"
                    done
                fi
            fi

            echo ""
            echo "--- Checking current directory contents ---"
            ls -lha "$SEARCH_ROOT" | grep -E "plan|tfplan" || echo "No plan files in root"

            echo ""
            echo "--- Summary ---"
            if [ -n "$FOUND_FILES" ]; then
                echo "Found potential plan files:"
                echo "$FOUND_FILES" | grep -v "^$"
                
                echo ""
                echo "To inspect a plan file:"
                echo "  Binary: terraform show <file>"
                echo "  JSON: jq . <file> | less"
                echo "  Convert binary to JSON: terraform show -json <file> > plan.json"
            else
                echo "No plan files found."
                echo ""
                echo "The plan might not be saved. To create one:"
                echo "  terraform plan -out=tfplan"
                echo "  terraform show -json tfplan > plan.json"
            fi
     
        - name: Submit Plan to Overmind
          run: |
            set -xe
            # Construct the env0 deployment URL for the ticket-link
            ticket_link="https://app.env0.com/p/${ENV0_PROJECT_ID}/environments/${ENV0_ENVIRONMENT_ID}/deployments/${ENV0_DEPLOYMENT_LOG_ID}?organizationId=${ENV0_ORGANIZATION_ID}"
            
            terraform show -json > tfplan.json
            overmind changes submit-plan \
              tfplan.json \
              --title "Env0 Deployment: ${ENV0_DEPLOYMENT_LOG_ID}" \
              --ticket-link "$ticket_link"
    
    terraformApply:
      before:
        - name: Mark Change Started
          run: |
            set -xe
            # Construct the env0 deployment URL for the ticket-link
            ticket_link="https://app.env0.com/p/${ENV0_PROJECT_ID}/environments/${ENV0_ENVIRONMENT_ID}/deployments/${ENV0_DEPLOYMENT_LOG_ID}?organizationId=${ENV0_ORGANIZATION_ID}"
            
            # Start the change in Overmind
            overmind changes start-change \
              --ticket-link "$ticket_link"
      
      after:
        - name: Mark Change Finished
          run: |
            set -xe
            # Construct the env0 deployment URL for the ticket-link
            ticket_link="https://app.env0.com/p/${ENV0_PROJECT_ID}/environments/${ENV0_ENVIRONMENT_ID}/deployments/${ENV0_DEPLOYMENT_LOG_ID}?organizationId=${ENV0_ORGANIZATION_ID}"
            
            # End the change in Overmind
            overmind changes end-change \
              --ticket-link "$ticket_link"

