version: 2

deploy:
  steps:
    # COMMENTED OUT: Overmind integration steps
    terraformPlan:
      after:
        - name: Install Overmind CLI
          run: |
            #!/bin/sh
            set -e

            REPO="overmindtech/cli"

            # Preferred installation directories (in order of preference)
            PREFERRED_DIRS="/home/node/.local/bin:${HOME}/.local/bin:/opt/packages/bin:/usr/local/bin"

            OS=$(uname -s)
            ARCH=$(uname -m)

            case "${ARCH}" in
                x86_64) ARCH="x86_64" ;;
                aarch64|arm64) ARCH="arm64" ;;
                i386|i686) ARCH="i386" ;;
                *) echo "Unsupported architecture: ${ARCH}"; exit 1 ;;
            esac

            case "${OS}" in
                Linux|Darwin) ARCHIVE_EXT="tar.gz" ;;
                MINGW*|MSYS*|CYGWIN*) OS="Windows"; ARCHIVE_EXT="zip" ;;
                *) echo "Unsupported OS: ${OS}"; exit 1 ;;
            esac

            # Function to check if directory is writable and in PATH
            find_install_dir() {
                # First try preferred directories
                IFS=':'
                for dir in $PREFERRED_DIRS; do
                    [ -z "$dir" ] && continue
                    
                    # Create if parent is writable
                    if [ ! -d "$dir" ]; then
                        mkdir -p "$dir" 2>/dev/null || continue
                    fi
                    
                    # Check if writable and in PATH
                    if [ -w "$dir" ] && echo ":${PATH}:" | grep -q ":${dir}:"; then
                        echo "$dir"
                        return 0
                    fi
                done
                
                # Fall back to any writable directory in PATH
                for dir in $PATH; do
                    [ -z "$dir" ] && continue
                    [ -d "$dir" ] && [ -w "$dir" ] && echo "$dir" && return 0
                done
                unset IFS
                
                return 1
            }

            INSTALL_DIR=$(find_install_dir)

            if [ -z "${INSTALL_DIR}" ]; then
                echo "Error: No writable directory found in PATH"
                echo "Tried: ${PREFERRED_DIRS}"
                echo "Current PATH: ${PATH}"
                exit 1
            fi

            echo "Installing to: ${INSTALL_DIR}"

            echo "Detecting latest release..."
            LATEST_VERSION=$(curl -fsSL "https://api.github.com/repos/${REPO}/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')

            if [ -z "${LATEST_VERSION}" ]; then
                echo "Failed to fetch latest version"
                exit 1
            fi

            echo "Latest version: ${LATEST_VERSION}"
            VERSION_NUMBER=$(echo "${LATEST_VERSION}" | sed 's/^v//')

            FILENAME="overmind_cli_${VERSION_NUMBER}_${OS}_${ARCH}.${ARCHIVE_EXT}"
            DOWNLOAD_URL="https://github.com/${REPO}/releases/download/${LATEST_VERSION}/${FILENAME}"

            echo "Downloading ${FILENAME}..."

            TMP_DIR=$(mktemp -d)
            trap "rm -rf ${TMP_DIR}" EXIT
            cd "${TMP_DIR}"

            curl -fsSL "${DOWNLOAD_URL}" -o archive

            if [ "${ARCHIVE_EXT}" = "tar.gz" ]; then
                tar -xzf archive
            else
                unzip -q archive
            fi

            # Look for the binary - it's called 'overmind'
            BINARY=$(find . -maxdepth 1 -type f -executable -name "overmind*" ! -name "*.txt" ! -name "*.md" ! -name "LICENSE" | head -n 1)

            if [ -z "${BINARY}" ]; then
                echo "Error: Could not find binary in archive"
                ls -la
                exit 1
            fi

            cp "${BINARY}" "${INSTALL_DIR}/overmind"
            chmod +x "${INSTALL_DIR}/overmind"

            echo "✓ Overmind CLI ${LATEST_VERSION} installed to ${INSTALL_DIR}/overmind"
            echo "✓ Directory is already in PATH"

            "${INSTALL_DIR}/overmind" version 2>/dev/null || echo "Installation complete"
     
        - name: Find Terraform Plan File
          run: |
            set -xe
            echo "=========================================="
            echo "SEARCHING FOR TERRAFORM PLAN FILE"
            echo "=========================================="
            echo ""
            
            # Display environment context
            echo "=== ENV0 ENVIRONMENT CONTEXT ==="
            echo "Environment ID: ${ENV0_ENVIRONMENT_ID:-not set}"
            echo "Project ID: ${ENV0_PROJECT_ID:-not set}"
            echo "Project Name: ${ENV0_PROJECT_NAME:-not set}"
            echo "Deployment Log ID: ${ENV0_DEPLOYMENT_LOG_ID:-not set}"
            echo "Deployment Type: ${ENV0_DEPLOYMENT_TYPE:-not set}"
            echo "Workspace Name: ${ENV0_WORKSPACE_NAME:-not set}"
            echo "Root Directory: ${ENV0_ROOT_DIR:-not set}"
            echo "Current Directory: $(pwd)"
            echo ""
            
            # Common plan file names to search for (space-separated for sh compatibility)
            PLAN_NAMES="terraform.tfplan tfplan plan.out plan.tfplan"
            
            PLAN_FILE=""
            PLAN_LOCATION=""
            FOUND=0
            
            # Search in current directory first
            echo "=== SEARCHING CURRENT DIRECTORY ==="
            for plan_name in $PLAN_NAMES; do
              if [ "$FOUND" -eq 1 ]; then
                break
              fi
              if [ -f "$plan_name" ]; then
                PLAN_FILE="$plan_name"
                PLAN_LOCATION="$(pwd)/$plan_name"
                echo "Found: $PLAN_LOCATION"
                FOUND=1
                break
              fi
            done
            
            # Also check for any .tfplan files
            if [ "$FOUND" -eq 0 ]; then
              for file in *.tfplan; do
                if [ -f "$file" ] && [ "$file" != "*.tfplan" ]; then
                  PLAN_FILE="$file"
                  PLAN_LOCATION="$(pwd)/$file"
                  echo "Found: $PLAN_LOCATION"
                  FOUND=1
                  break
                fi
              done
            fi
            
            # If not found, search in common locations
            if [ "$FOUND" -eq 0 ]; then
              echo "Not found in current directory, searching common locations..."
              echo ""
              
              SEARCH_DIRS=". ${ENV0_ROOT_DIR:-.} $HOME /tmp /var/tmp"
              
              for search_dir in $SEARCH_DIRS; do
                if [ "$FOUND" -eq 1 ]; then
                  break
                fi
                if [ -d "$search_dir" ]; then
                  echo "Searching in: $search_dir"
                  for plan_name in $PLAN_NAMES; do
                    found=$(find "$search_dir" -maxdepth 3 -name "$plan_name" -type f 2>/dev/null | head -1)
                    if [ -n "$found" ] && [ -f "$found" ]; then
                      PLAN_FILE=$(basename "$found")
                      PLAN_LOCATION="$found"
                      echo "Found: $PLAN_LOCATION"
                      FOUND=1
                      break
                    fi
                  done
                  # Also search for .tfplan files
                  if [ "$FOUND" -eq 0 ]; then
                    found=$(find "$search_dir" -maxdepth 3 -name "*.tfplan" -type f 2>/dev/null | head -1)
                    if [ -n "$found" ] && [ -f "$found" ]; then
                      PLAN_FILE=$(basename "$found")
                      PLAN_LOCATION="$found"
                      echo "Found: $PLAN_LOCATION"
                      FOUND=1
                    fi
                  fi
                fi
              done
            fi
            
            # Try to use terraform show to detect plan
            if [ "$FOUND" -eq 0 ]; then
              echo ""
              echo "=== ATTEMPTING TERRAFORM SHOW DETECTION ==="
              if command -v terraform >/dev/null 2>&1; then
                # Try terraform show without specifying a file (uses last plan)
                if terraform show -json 2>/dev/null | head -1 | grep -q "format_version"; then
                  echo "Terraform show detected a plan (using last plan in state)"
                  PLAN_FILE="(detected via terraform show)"
                  PLAN_LOCATION="(last plan in terraform state)"
                  FOUND=1
                else
                  echo "No plan detected via terraform show"
                fi
              else
                echo "Terraform command not found"
              fi
            fi
            
            # Display results
            echo ""
            echo "=========================================="
            echo "PLAN FILE SEARCH RESULTS"
            echo "=========================================="
            if [ "$FOUND" -eq 1 ] && [ "$PLAN_FILE" != "(detected via terraform show)" ]; then
              echo "✓ Plan file found: $PLAN_LOCATION"
              echo "  File name: $PLAN_FILE"
              echo "  Full path: $PLAN_LOCATION"
              echo "  File size: $(du -h "$PLAN_LOCATION" | cut -f1)"
              echo "  File permissions: $(ls -l "$PLAN_LOCATION" | awk '{print $1}')"
              echo ""
              echo "Storing plan file location for next steps..."
              echo "PLAN_FILE=$PLAN_LOCATION" >> $ENV0_ENV
              echo "PLAN_FILE_NAME=$PLAN_FILE" >> $ENV0_ENV
            elif [ "$PLAN_FILE" = "(detected via terraform show)" ]; then
              echo "⚠ Plan detected via terraform show (no file path available)"
              echo "  Will use 'terraform show -json' without file argument"
              echo ""
              echo "PLAN_FILE=" >> $ENV0_ENV
              echo "PLAN_FILE_NAME=(terraform show)" >> $ENV0_ENV
            else
              echo "✗ No plan file found"
              echo "  Searched for: $PLAN_NAMES *.tfplan"
              echo "  Searched in: current directory and common locations"
              echo ""
              echo "Listing current directory contents:"
              ls -la
              echo ""
              echo "WARNING: Plan file not found. Subsequent steps may fail."
              echo "PLAN_FILE=" >> $ENV0_ENV
              echo "PLAN_FILE_NAME=" >> $ENV0_ENV
            fi
            echo "=========================================="
     