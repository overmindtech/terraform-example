version: 2

deploy:
  steps:
    terraformPlan:
      before:
        - name: Gather Environment Information
          run: |
            echo "=========================================="
            echo "ENVIRONMENT INFORMATION GATHERING"
            echo "=========================================="
            echo ""
            
            # Operating System Information
            echo "=== OPERATING SYSTEM ==="
            if [ -f /etc/os-release ]; then
                echo "OS Release Info:"
                cat /etc/os-release
                echo ""
            fi
            
            if [ -f /etc/redhat-release ]; then
                echo "RedHat Release:"
                cat /etc/redhat-release
                echo ""
            fi
            
            if [ -f /etc/debian_version ]; then
                echo "Debian Version:"
                cat /etc/debian_version
                echo ""
            fi
            
            echo "Kernel Information:"
            uname -a
            echo ""
            
            echo "Hostname:"
            hostname
            echo ""
            
            # Architecture Information
            echo "=== ARCHITECTURE ==="
            echo "Machine Hardware: $(uname -m)"
            echo "Processor Type: $(uname -p)"
            echo "Hardware Platform: $(uname -i)"
            echo ""
            
            # CPU Information
            echo "=== CPU INFORMATION ==="
            if [ -f /proc/cpuinfo ]; then
                echo "CPU Model:"
                grep "model name" /proc/cpuinfo | head -1 | cut -d: -f2 | xargs
                echo "CPU Cores: $(grep -c processor /proc/cpuinfo)"
                echo ""
            fi
            
            # Memory Information
            echo "=== MEMORY INFORMATION ==="
            if [ -f /proc/meminfo ]; then
                echo "Total Memory:"
                grep MemTotal /proc/meminfo
                echo "Available Memory:"
                grep MemAvailable /proc/meminfo || grep MemFree /proc/meminfo
                echo ""
            fi
            
            # Disk Information
            echo "=== DISK INFORMATION ==="
            df -h
            echo ""
            
            # Network Information
            echo "=== NETWORK INFORMATION ==="
            echo "IP Addresses:"
            ip addr show 2>/dev/null || ifconfig 2>/dev/null || echo "Network tools not available"
            echo ""
            
            # Package Managers
            echo "=== PACKAGE MANAGERS ==="
            echo "Checking for available package managers:"
            echo ""
            
            if command -v apt-get &> /dev/null; then
                echo "✓ apt-get (Debian/Ubuntu) is available"
                echo "  Version: $(apt-get --version | head -1)"
                echo ""
            fi
            
            if command -v yum &> /dev/null; then
                echo "✓ yum (RHEL/CentOS) is available"
                echo "  Version: $(yum --version | head -1)"
                echo ""
            fi
            
            if command -v dnf &> /dev/null; then
                echo "✓ dnf (Fedora/RHEL8+) is available"
                echo "  Version: $(dnf --version | head -1)"
                echo ""
            fi
            
            if command -v apk &> /dev/null; then
                echo "✓ apk (Alpine) is available"
                echo "  Version: $(apk --version | head -1)"
                echo ""
            fi
            
            if command -v pacman &> /dev/null; then
                echo "✓ pacman (Arch) is available"
                echo "  Version: $(pacman --version | head -1)"
                echo ""
            fi
            
            if command -v brew &> /dev/null; then
                echo "✓ brew (Homebrew) is available"
                echo "  Version: $(brew --version | head -1)"
                echo ""
            fi
            
            # Installed Packages (sample)
            echo "=== INSTALLED PACKAGES (Sample) ==="
            if command -v dpkg &> /dev/null; then
                echo "Debian/Ubuntu packages (first 20):"
                dpkg -l | head -20
                echo ""
            fi
            
            if command -v rpm &> /dev/null; then
                echo "RPM packages (first 20):"
                rpm -qa | head -20
                echo ""
            fi
            
            if command -v apk &> /dev/null; then
                echo "Alpine packages (first 20):"
                apk list --installed | head -20
                echo ""
            fi
            
            # Common Tools Availability
            echo "=== COMMON TOOLS AVAILABILITY ==="
            TOOLS=(
                "curl" "wget" "git" "python3" "python" "pip" "pip3"
                "node" "npm" "yarn" "go" "rustc" "cargo"
                "docker" "kubectl" "helm" "terraform" "ansible"
                "jq" "yq" "aws" "gcloud" "az" "kubectl"
                "make" "cmake" "gcc" "g++" "clang" "java"
                "ruby" "perl" "php" "bash" "zsh" "fish"
                "tar" "zip" "unzip" "gzip" "bzip2"
                "vim" "nano" "emacs" "nano"
            )
            
            for tool in "${TOOLS[@]}"; do
                if command -v "$tool" &> /dev/null; then
                    version_output=$($tool --version 2>&1 | head -1 || echo "version unknown")
                    echo "✓ $tool: $version_output"
                else
                    echo "✗ $tool: not found"
                fi
            done
            echo ""
            
            # Environment Variables
            echo "=== ENVIRONMENT VARIABLES ==="
            echo "All environment variables:"
            env | sort
            echo ""
            
            # PATH Information
            echo "=== PATH INFORMATION ==="
            echo "PATH: $PATH"
            echo ""
            echo "PATH directories:"
            echo "$PATH" | tr ':' '\n' | while read -r dir; do
                if [ -d "$dir" ]; then
                    echo "  ✓ $dir"
                else
                    echo "  ✗ $dir (does not exist)"
                fi
            done
            echo ""
            
            # Shell Information
            echo "=== SHELL INFORMATION ==="
            echo "Current Shell: $SHELL"
            echo "Shell Version: $($SHELL --version 2>&1 | head -1 || echo "unknown")"
            echo ""
            
            # User Information
            echo "=== USER INFORMATION ==="
            echo "Current User: $(whoami)"
            echo "User ID: $(id)"
            echo "Home Directory: $HOME"
            echo ""
            
            # Working Directory
            echo "=== WORKING DIRECTORY ==="
            echo "Current Directory: $(pwd)"
            echo "Directory Contents:"
            ls -la
            echo ""
            
            # System Services (if systemd)
            echo "=== SYSTEM SERVICES (if systemd available) ==="
            if command -v systemctl &> /dev/null; then
                echo "Active services (first 10):"
                systemctl list-units --type=service --state=running | head -10
                echo ""
            else
                echo "systemctl not available"
                echo ""
            fi
            
            # Container Information (if in container)
            echo "=== CONTAINER INFORMATION ==="
            if [ -f /.dockerenv ]; then
                echo "✓ Running in Docker container"
            fi
            
            if [ -f /proc/1/cgroup ]; then
                echo "Cgroup information:"
                head -1 /proc/1/cgroup
                echo ""
            fi
            
            # Time Information
            echo "=== TIME INFORMATION ==="
            echo "Current Date/Time: $(date)"
            echo "Timezone: $(cat /etc/timezone 2>/dev/null || timedatectl show -p Timezone --value 2>/dev/null || echo "unknown")"
            echo "Uptime: $(uptime 2>/dev/null || echo "unknown")"
            echo ""
            
            # File System Information
            echo "=== FILE SYSTEM INFORMATION ==="
            echo "Mount Points:"
            mount | head -10
            echo ""
            
            # Process Information
            echo "=== PROCESS INFORMATION ==="
            echo "Running processes (first 10):"
            ps aux | head -10
            echo ""
            
            # Locale Information
            echo "=== LOCALE INFORMATION ==="
            locale 2>/dev/null || echo "Locale information not available"
            echo ""
            
            # DNS Information
            echo "=== DNS INFORMATION ==="
            if [ -f /etc/resolv.conf ]; then
                echo "DNS Configuration:"
                cat /etc/resolv.conf
                echo ""
            fi
            
            # Environment-specific Information
            echo "=== ENV0 SPECIFIC ENVIRONMENT VARIABLES ==="
            env | grep -E "^ENV0_" | sort || echo "No ENV0_ variables found"
            echo ""
            
            echo "=========================================="
            echo "ENVIRONMENT INFORMATION GATHERING COMPLETE"
            echo "=========================================="
    
    # COMMENTED OUT: Overmind integration steps
    # terraformPlan:
    #   after:
    #     - name: Install Overmind CLI
    #       run: |
    #         set -xe
    #         # Download and install Overmind CLI
    #         # Using the same method as the GitHub action: download from releases
    #         curl -L https://github.com/overmindtech/cli/releases/latest/download/overmind_cli_Linux_x86_64.tar.gz -o /tmp/overmind.tar.gz
    #         mkdir -p ./overmindtech
    #         tar -xzf /tmp/overmind.tar.gz -C ./overmindtech
    #         chmod +x ./overmindtech/overmind
    #         ./overmindtech/overmind --version
    #     
    #     - name: Convert Terraform Plan to JSON
    #       run: |
    #         set -xe
    #         # Find the plan file created by env0 (common names: terraform.tfplan, tfplan, or plan.out)
    #         PLAN_FILE=""
    #         for plan in terraform.tfplan tfplan plan.out *.tfplan; do
    #           if [ -f "$plan" ]; then
    #             PLAN_FILE="$plan"
    #             break
    #           fi
    #         done
    #         
    #         if [ -z "$PLAN_FILE" ]; then
    #           echo "Warning: No plan file found, attempting to use terraform show without file"
    #           terraform show -json > tfplan.json
    #         else
    #           echo "Using plan file: $PLAN_FILE"
    #           terraform show -json "$PLAN_FILE" > tfplan.json
    #         fi
    #         
    #         if [ ! -f tfplan.json ] || [ ! -s tfplan.json ]; then
    #           echo "Error: Failed to create tfplan.json"
    #           exit 1
    #         fi
    #     
    #     - name: Submit Plan to Overmind
    #       run: |
    #         set -xe
    #         # Ensure OVM_API_KEY is set (should be configured as env0 environment variable)
    #         if [ -z "$OVM_API_KEY" ]; then
    #           echo "Warning: OVM_API_KEY not set. Overmind commands may fail."
    #         fi
    #         
    #         # Construct the env0 deployment URL using available environment variables
    #         if [ -n "$ENV0_ORGANIZATION_ID" ] && [ -n "$ENV0_ENVIRONMENT_ID" ] && [ -n "$ENV0_DEPLOYMENT_LOG_ID" ]; then
    #           ticket_link="https://app.env0.com/organizations/${ENV0_ORGANIZATION_ID}/environments/${ENV0_ENVIRONMENT_ID}/deployments/${ENV0_DEPLOYMENT_LOG_ID}"
    #         else
    #           ticket_link="https://app.env0.com"
    #         fi
    #         
    #         # Build title with project and workspace info
    #         title="Deploying ${ENV0_PROJECT_NAME:-Project}"
    #         if [ -n "$ENV0_WORKSPACE_NAME" ]; then
    #           title="${title} (workspace: ${ENV0_WORKSPACE_NAME})"
    #         fi
    #         title="${title} via env0"
    #         
    #         description="This change was automatically created from env0 deployment"
    #         if [ -n "$ENV0_DEPLOYMENT_TYPE" ]; then
    #           description="${description} (type: ${ENV0_DEPLOYMENT_TYPE})"
    #         fi
    #         if [ -n "$ENV0_DEPLOYMENT_REVISION" ]; then
    #           description="${description} (revision: ${ENV0_DEPLOYMENT_REVISION})"
    #         fi
    #         
    #         ./overmindtech/overmind changes submit-plan \
    #           --title "$title" \
    #           --description "$description" \
    #           --ticket-link "$ticket_link" \
    #           tfplan.json \
    #           > ./overmindtech/change-url || true
    #         
    #         # Store the change URL for later steps
    #         if [ -f ./overmindtech/change-url ] && [ -s ./overmindtech/change-url ]; then
    #           CHANGE_URL=$(cat ./overmindtech/change-url)
    #           echo "CHANGE_URL=$CHANGE_URL" >> $ENV0_ENV
    #           echo "Change URL: $CHANGE_URL"
    #         else
    #           echo "Warning: Failed to get change URL from Overmind"
    #         fi
    
    # terraformApply:
    #   before:
    #     - name: Mark Change Started
    #       run: |
    #         set -xe
    #         # Ensure OVM_API_KEY is set
    #         if [ -z "$OVM_API_KEY" ]; then
    #           echo "Warning: OVM_API_KEY not set. Overmind commands may fail."
    #         fi
    #         
    #         # Start the change in Overmind
    #         # Use the change URL if available, otherwise use ticket-link
    #         if [ -n "$CHANGE_URL" ]; then
    #           ./overmindtech/overmind changes start-change \
    #             --change "$CHANGE_URL" || true
    #         else
    #           # Construct the env0 deployment URL using available environment variables
    #           if [ -n "$ENV0_ORGANIZATION_ID" ] && [ -n "$ENV0_ENVIRONMENT_ID" ] && [ -n "$ENV0_DEPLOYMENT_LOG_ID" ]; then
    #             ticket_link="https://app.env0.com/organizations/${ENV0_ORGANIZATION_ID}/environments/${ENV0_ENVIRONMENT_ID}/deployments/${ENV0_DEPLOYMENT_LOG_ID}"
    #           else
    #             ticket_link="https://app.env0.com"
    #           fi
    #           ./overmindtech/overmind changes start-change \
    #             --ticket-link "$ticket_link" || true
    #         fi
    #   
    #   after:
    #     - name: Mark Change Finished
    #       run: |
    #         set -xe
    #         # Ensure OVM_API_KEY is set
    #         if [ -z "$OVM_API_KEY" ]; then
    #           echo "Warning: OVM_API_KEY not set. Overmind commands may fail."
    #         fi
    #         
    #         # End the change in Overmind
    #         # Use the change URL if available, otherwise use ticket-link
    #         if [ -n "$CHANGE_URL" ]; then
    #           ./overmindtech/overmind changes end-change \
    #             --change "$CHANGE_URL" || true
    #         else
    #           # Construct the env0 deployment URL using available environment variables
    #           if [ -n "$ENV0_ORGANIZATION_ID" ] && [ -n "$ENV0_ENVIRONMENT_ID" ] && [ -n "$ENV0_DEPLOYMENT_LOG_ID" ]; then
    #             ticket_link="https://app.env0.com/organizations/${ENV0_ORGANIZATION_ID}/environments/${ENV0_ENVIRONMENT_ID}/deployments/${ENV0_DEPLOYMENT_LOG_ID}"
    #           else
    #             ticket_link="https://app.env0.com"
    #           fi
    #           ./overmindtech/overmind changes end-change \
    #             --ticket-link "$ticket_link" || true
    #         fi

