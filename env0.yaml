version: 2

deploy:
  steps:
    # COMMENTED OUT: Overmind integration steps
    terraformPlan:
      after:
        - name: Install Overmind CLI
          run: |
            #!/bin/sh
            set -e

            REPO="overmindtech/cli"

            # Detect OS and architecture
            OS=$(uname -s)
            ARCH=$(uname -m)

            case "${ARCH}" in
                x86_64) ARCH="x86_64" ;;
                aarch64|arm64) ARCH="arm64" ;;
                i386|i686) ARCH="i386" ;;
                *) echo "Unsupported architecture: ${ARCH}"; exit 1 ;;
            esac

            case "${OS}" in
                Linux|Darwin) ARCHIVE_EXT="tar.gz" ;;
                MINGW*|MSYS*|CYGWIN*) OS="Windows"; ARCHIVE_EXT="zip" ;;
                *) echo "Unsupported OS: ${OS}"; exit 1 ;;
            esac

            # Find first writable directory in PATH
            INSTALL_DIR=""
            IFS=':'
            for dir in $PATH; do
                # Skip empty entries
                [ -z "$dir" ] && continue
                
                # Check if directory exists and is writable
                if [ -d "$dir" ] && [ -w "$dir" ]; then
                    INSTALL_DIR="$dir"
                    echo "Found writable directory in PATH: ${INSTALL_DIR}"
                    break
                fi
                
                # If directory doesn't exist but parent is writable, we can create it
                parent=$(dirname "$dir")
                if [ ! -d "$dir" ] && [ -d "$parent" ] && [ -w "$parent" ]; then
                    mkdir -p "$dir" 2>/dev/null && INSTALL_DIR="$dir" && echo "Created directory in PATH: ${INSTALL_DIR}" && break
                fi
            done
            unset IFS

            if [ -z "${INSTALL_DIR}" ]; then
                echo "Error: No writable directory found in PATH"
                echo "Current PATH: ${PATH}"
                exit 1
            fi

            echo "Detecting latest release..."
            LATEST_VERSION=$(curl -fsSL "https://api.github.com/repos/${REPO}/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')

            if [ -z "${LATEST_VERSION}" ]; then
                echo "Failed to fetch latest version"
                exit 1
            fi

            echo "Latest version: ${LATEST_VERSION}"
            VERSION_NUMBER=$(echo "${LATEST_VERSION}" | sed 's/^v//')

            FILENAME="overmind_cli_${VERSION_NUMBER}_${OS}_${ARCH}.${ARCHIVE_EXT}"
            DOWNLOAD_URL="https://github.com/${REPO}/releases/download/${LATEST_VERSION}/${FILENAME}"

            echo "Downloading ${FILENAME}..."

            TMP_DIR=$(mktemp -d)
            trap "rm -rf ${TMP_DIR}" EXIT
            cd "${TMP_DIR}"

            curl -fsSL "${DOWNLOAD_URL}" -o archive

            # Extract
            if [ "${ARCHIVE_EXT}" = "tar.gz" ]; then
                tar -xzf archive
            else
                unzip -q archive
            fi

            BINARY=$(find . -maxdepth 1 -type f \( -name "overmind-cli*" -o -name "overmind_cli*" \) ! -name "*.txt" | head -n 1)

            if [ -z "${BINARY}" ]; then
                echo "Error: Could not find binary in archive"
                ls -la
                exit 1
            fi

            cp "${BINARY}" "${INSTALL_DIR}/overmind-cli"
            chmod +x "${INSTALL_DIR}/overmind-cli"

            echo "✓ Overmind CLI ${LATEST_VERSION} installed to ${INSTALL_DIR}/overmind-cli"
            echo "✓ Installation directory is already in PATH"

            "${INSTALL_DIR}/overmind-cli" version 2>/dev/null || echo "Installation complete"
    #     
    #     - name: Convert Terraform Plan to JSON
    #       run: |
    #         set -xe
    #         # Find the plan file created by env0 (common names: terraform.tfplan, tfplan, or plan.out)
    #         PLAN_FILE=""
    #         for plan in terraform.tfplan tfplan plan.out *.tfplan; do
    #           if [ -f "$plan" ]; then
    #             PLAN_FILE="$plan"
    #             break
    #           fi
    #         done
    #         
    #         if [ -z "$PLAN_FILE" ]; then
    #           echo "Warning: No plan file found, attempting to use terraform show without file"
    #           terraform show -json > tfplan.json
    #         else
    #           echo "Using plan file: $PLAN_FILE"
    #           terraform show -json "$PLAN_FILE" > tfplan.json
    #         fi
    #         
    #         if [ ! -f tfplan.json ] || [ ! -s tfplan.json ]; then
    #           echo "Error: Failed to create tfplan.json"
    #           exit 1
    #         fi
    #     
    #     - name: Submit Plan to Overmind
    #       run: |
    #         set -xe
    #         # Ensure OVM_API_KEY is set (should be configured as env0 environment variable)
    #         if [ -z "$OVM_API_KEY" ]; then
    #           echo "Warning: OVM_API_KEY not set. Overmind commands may fail."
    #         fi
    #         
    #         # Construct the env0 deployment URL using available environment variables
    #         if [ -n "$ENV0_ORGANIZATION_ID" ] && [ -n "$ENV0_ENVIRONMENT_ID" ] && [ -n "$ENV0_DEPLOYMENT_LOG_ID" ]; then
    #           ticket_link="https://app.env0.com/organizations/${ENV0_ORGANIZATION_ID}/environments/${ENV0_ENVIRONMENT_ID}/deployments/${ENV0_DEPLOYMENT_LOG_ID}"
    #         else
    #           ticket_link="https://app.env0.com"
    #         fi
    #         
    #         # Build title with project and workspace info
    #         title="Deploying ${ENV0_PROJECT_NAME:-Project}"
    #         if [ -n "$ENV0_WORKSPACE_NAME" ]; then
    #           title="${title} (workspace: ${ENV0_WORKSPACE_NAME})"
    #         fi
    #         title="${title} via env0"
    #         
    #         description="This change was automatically created from env0 deployment"
    #         if [ -n "$ENV0_DEPLOYMENT_TYPE" ]; then
    #           description="${description} (type: ${ENV0_DEPLOYMENT_TYPE})"
    #         fi
    #         if [ -n "$ENV0_DEPLOYMENT_REVISION" ]; then
    #           description="${description} (revision: ${ENV0_DEPLOYMENT_REVISION})"
    #         fi
    #         
    #         ./overmindtech/overmind changes submit-plan \
    #           --title "$title" \
    #           --description "$description" \
    #           --ticket-link "$ticket_link" \
    #           tfplan.json \
    #           > ./overmindtech/change-url || true
    #         
    #         # Store the change URL for later steps
    #         if [ -f ./overmindtech/change-url ] && [ -s ./overmindtech/change-url ]; then
    #           CHANGE_URL=$(cat ./overmindtech/change-url)
    #           echo "CHANGE_URL=$CHANGE_URL" >> $ENV0_ENV
    #           echo "Change URL: $CHANGE_URL"
    #         else
    #           echo "Warning: Failed to get change URL from Overmind"
    #         fi

    # terraformApply:
    #   before:
    #     - name: Mark Change Started
    #       run: |
    #         set -xe
    #         # Ensure OVM_API_KEY is set
    #         if [ -z "$OVM_API_KEY" ]; then
    #           echo "Warning: OVM_API_KEY not set. Overmind commands may fail."
    #         fi
    #         
    #         # Start the change in Overmind
    #         # Use the change URL if available, otherwise use ticket-link
    #         if [ -n "$CHANGE_URL" ]; then
    #           ./overmindtech/overmind changes start-change \
    #             --change "$CHANGE_URL" || true
    #         else
    #           # Construct the env0 deployment URL using available environment variables
    #           if [ -n "$ENV0_ORGANIZATION_ID" ] && [ -n "$ENV0_ENVIRONMENT_ID" ] && [ -n "$ENV0_DEPLOYMENT_LOG_ID" ]; then
    #             ticket_link="https://app.env0.com/organizations/${ENV0_ORGANIZATION_ID}/environments/${ENV0_ENVIRONMENT_ID}/deployments/${ENV0_DEPLOYMENT_LOG_ID}"
    #           else
    #             ticket_link="https://app.env0.com"
    #           fi
    #           ./overmindtech/overmind changes start-change \
    #             --ticket-link "$ticket_link" || true
    #         fi
    #   
    #   after:
    #     - name: Mark Change Finished
    #       run: |
    #         set -xe
    #         # Ensure OVM_API_KEY is set
    #         if [ -z "$OVM_API_KEY" ]; then
    #           echo "Warning: OVM_API_KEY not set. Overmind commands may fail."
    #         fi
    #         
    #         # End the change in Overmind
    #         # Use the change URL if available, otherwise use ticket-link
    #         if [ -n "$CHANGE_URL" ]; then
    #           ./overmindtech/overmind changes end-change \
    #             --change "$CHANGE_URL" || true
    #         else
    #           # Construct the env0 deployment URL using available environment variables
    #           if [ -n "$ENV0_ORGANIZATION_ID" ] && [ -n "$ENV0_ENVIRONMENT_ID" ] && [ -n "$ENV0_DEPLOYMENT_LOG_ID" ]; then
    #             ticket_link="https://app.env0.com/organizations/${ENV0_ORGANIZATION_ID}/environments/${ENV0_ENVIRONMENT_ID}/deployments/${ENV0_DEPLOYMENT_LOG_ID}"
    #           else
    #             ticket_link="https://app.env0.com"
    #           fi
    #           ./overmindtech/overmind changes end-change \
    #             --ticket-link "$ticket_link" || true
    #         fi