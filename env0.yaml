version: 2

deploy:
  steps:
    terraformPlan:
      before:
        - name: Display Shell Information
          run: |
            echo "=========================================="
            echo "SHELL INFORMATION"
            echo "=========================================="
            echo "Current Shell: $SHELL"
            echo "Shell Process: $$"
            echo "Parent Shell: $0"
            echo ""
            echo "Shell Version:"
            if [ -n "$SHELL" ]; then
              $SHELL --version 2>&1 || echo "Version command not available"
            fi
            echo ""
            echo "Available Shells:"
            which sh 2>/dev/null && echo "  sh: $(sh --version 2>&1 | head -1)" || echo "  sh: not found"
            which bash 2>/dev/null && echo "  bash: $(bash --version 2>&1 | head -1)" || echo "  bash: not found"
            which zsh 2>/dev/null && echo "  zsh: $(zsh --version 2>&1 | head -1)" || echo "  zsh: not found"
            which dash 2>/dev/null && echo "  dash: $(dash --version 2>&1 | head -1)" || echo "  dash: not found"
            echo ""
            echo "Current Process Info:"
            ps -p $$ -o comm=,args= 2>/dev/null || ps -p $$ 2>/dev/null || echo "ps command not available"
            echo ""
            echo "=========================================="

      after:
        - name: Submit Plan to Overmind
          use: https://github.com/overmindtech/env0-plugin
          inputs:
            action: submit-plan
            api_key: ${OVM_API_KEY}
    
    terraformApply:
      before:
        - name: Mark Change Started
          use: https://github.com/overmindtech/env0-plugin
          inputs:
            action: start-change
            api_key: ${OVM_API_KEY}

        - name: Display Shell Information
          run: |
            echo "=========================================="
            echo "SHELL INFORMATION"
            echo "=========================================="
            echo "Current Shell: $SHELL"
            echo "Shell Process: $$"
            echo "Parent Shell: $0"
            echo ""
            echo "Shell Version:"
            if [ -n "$SHELL" ]; then
              $SHELL --version 2>&1 || echo "Version command not available"
            fi
            echo ""
            echo "Available Shells:"
            which sh 2>/dev/null && echo "  sh: $(sh --version 2>&1 | head -1)" || echo "  sh: not found"
            which bash 2>/dev/null && echo "  bash: $(bash --version 2>&1 | head -1)" || echo "  bash: not found"
            which zsh 2>/dev/null && echo "  zsh: $(zsh --version 2>&1 | head -1)" || echo "  zsh: not found"
            which dash 2>/dev/null && echo "  dash: $(dash --version 2>&1 | head -1)" || echo "  dash: not found"
            echo ""
            echo "Current Process Info:"
            ps -p $$ -o comm=,args= 2>/dev/null || ps -p $$ 2>/dev/null || echo "ps command not available"
            echo ""
            echo "=========================================="
      
      after:
        - name: Mark Change Finished
          use: https://github.com/overmindtech/env0-plugin
          inputs:
            action: end-change
            api_key: ${OVM_API_KEY}

