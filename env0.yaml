version: 2

deploy:
  steps:
    terraformPlan:
      after:
        - name: Submit Plan to Overmind
          use: https://github.com/overmindtech/env0-plugin
          inputs:
            action: submit-plan
            api_key: ${OVM_API_KEY}
        - name: Wait for Analysis
          use: https://github.com/overmindtech/env0-plugin
          inputs:
            action: wait-for-simulation
            api_key: ${OVM_API_KEY}
            post_comment: false
        - name: Print Env Vars
          run: |
            env
    
    terraformApply:
      before:
        - name: Mark Change Started
          use: https://github.com/overmindtech/env0-plugin
          inputs:
            action: start-change
            api_key: ${OVM_API_KEY}
      
      after:
        - name: Mark Change Finished
          use: https://github.com/overmindtech/env0-plugin
          inputs:
            action: end-change
            api_key: ${OVM_API_KEY}
        - name: Print Env Vars
          run: |
            env

    terraformOutput:
      after:
        - name: Print Env Vars
          run: |
            env
